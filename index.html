
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload File lÃªn GitHub - ÄÃ£ Xá»­ LÃ½ Encoding</title>
</head>
<body>
    <div style="max-width: 600px; margin: 50px auto; padding: 20px;">
        <h1>ğŸ“¤ Upload File lÃªn GitHub (ÄÃ£ Xá»­ LÃ½ Encoding)</h1>
        <p><strong>Repo:</strong> Datkep92/aquyet</p>
        <p><strong>Path:</strong> docs/Quyet/processed/</p>
        
        <form id="uploadForm" style="margin-top: 20px;">
            <div style="margin-bottom: 15px;">
                <label><strong>TÃªn File (trÃªn GitHub):</strong></label><br>
                <input type="text" id="fileName" placeholder="book.html" required 
                       style="width: 100%; padding: 8px; margin-top: 5px;">
                <small style="color: #666;">VÃ­ dá»¥: book.html, chapter1.html</small>
            </div>

            <div style="margin-bottom: 15px;">
                <label><strong>GitHub Token:</strong></label><br>
                <input type="text" id="githubToken" placeholder="Nháº­p GitHub Token" required 
                       style="width: 100%; padding: 8px; margin-top: 5px;">
            </div>

            <div style="margin-bottom: 15px;">
                <label><strong>Chá»n File HTML:</strong></label><br>
                <input type="file" id="fileInput" accept=".html,.htm,.txt" required 
                       style="margin-top: 5px;">
                <div id="fileInfo" style="margin-top: 5px; color: #666;"></div>
            </div>

            <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="autoProcess" checked>
                    <strong>Tá»± Ä‘á»™ng xá»­ lÃ½ encoding (Windows-1252 â†’ UTF-8)</strong>
                </label>
                <small style="color: #666; display: block; margin-top: 5px;">
                    File sáº½ Ä‘Æ°á»£c xá»­ lÃ½ encoding trÆ°á»›c khi upload lÃªn GitHub
                </small>
            </div>

            <button type="submit" id="uploadBtn" 
                    style="width: 100%; padding: 12px; background: #28a745; color: white; border: none; cursor: pointer;">
                ğŸš€ Xá»­ LÃ½ & Upload lÃªn GitHub
            </button>
        </form>

        <div id="loading" style="display: none; text-align: center; margin: 20px 0;">
            <p>ğŸ”„ Äang xá»­ lÃ½ file vÃ  upload lÃªn GitHub...</p>
        </div>

        <div id="successResult" style="display: none; background: #d4edda; color: #155724; padding: 15px; margin-top: 20px; border-radius: 5px;">
            <h3>âœ… Upload ThÃ nh CÃ´ng!</h3>
            <p id="successMessage"></p>
            <p><strong>ğŸ“ Link:</strong> <a id="fileLink" target="_blank"></a></p>
            <p><strong>ğŸ“¥ Raw URL:</strong> <a id="rawLink" target="_blank"></a></p>
        </div>

        <div id="errorResult" style="display: none; background: #f8d7da; color: #721c24; padding: 15px; margin-top: 20px; border-radius: 5px;">
            <h3>âŒ Lá»—i Upload</h3>
            <p id="errorMessage"></p>
        </div>

        <!-- Preview Section -->
        <div id="previewSection" style="display: none; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
            <h3>ğŸ‘ï¸ Preview (Sau khi xá»­ lÃ½)</h3>
            <div id="previewContent" style="max-height: 200px; overflow-y: auto; background: white; padding: 10px; border: 1px solid #ddd; margin-top: 10px; font-family: monospace; font-size: 12px;"></div>
        </div>
    </div>

    <script>
        class GitHubUploader {
            constructor() {
                this.initializeElements();
                this.bindEvents();
            }

            initializeElements() {
                this.form = document.getElementById('uploadForm');
                this.fileInput = document.getElementById('fileInput');
                this.fileInfo = document.getElementById('fileInfo');
                this.fileNameInput = document.getElementById('fileName');
                this.githubToken = document.getElementById('githubToken');
                this.uploadBtn = document.getElementById('uploadBtn');
                this.autoProcess = document.getElementById('autoProcess');
                this.loading = document.getElementById('loading');
                this.successResult = document.getElementById('successResult');
                this.errorResult = document.getElementById('errorResult');
                this.successMessage = document.getElementById('successMessage');
                this.errorMessage = document.getElementById('errorMessage');
                this.fileLink = document.getElementById('fileLink');
                this.rawLink = document.getElementById('rawLink');
                this.previewSection = document.getElementById('previewSection');
                this.previewContent = document.getElementById('previewContent');
            }

            bindEvents() {
                this.form.addEventListener('submit', (e) => this.handleSubmit(e));
                this.fileInput.addEventListener('change', (e) => this.handleFileSelect(e));
                this.autoProcess.addEventListener('change', () => this.togglePreview());
            }

            handleFileSelect(e) {
                const file = e.target.files[0];
                if (file) {
                    this.fileInfo.textContent = `ğŸ“„ File: ${file.name} (${this.formatFileSize(file.size)})`;
                    // Tá»± Ä‘á»™ng Ä‘iá»n tÃªn file náº¿u chÆ°a cÃ³
                    if (!this.fileNameInput.value) {
                        const nameWithoutExt = file.name.replace(/\.[^/.]+$/, "");
                        this.fileNameInput.value = nameWithoutExt + '.html';
                    }
                    this.togglePreview();
                }
            }

            async handleSubmit(e) {
                e.preventDefault();
                
                const file = this.fileInput.files[0];
                const fileName = this.fileNameInput.value.trim();
                const token = this.githubToken.value.trim();

                if (!file || !fileName || !token) {
                    this.showError('Vui lÃ²ng Ä‘iá»n Ä‘áº§y Ä‘á»§ thÃ´ng tin!');
                    return;
                }

                this.showLoading();

                try {
                    const result = await this.processAndUpload(file, fileName, token);
                    this.showSuccess(result);
                } catch (error) {
                    this.showError(error.message);
                }
            }

            async processAndUpload(file, fileName, token) {
                // BÆ°á»›c 1: Äá»c file
                const originalContent = await this.readFileAsText(file);
                
                // BÆ°á»›c 2: Xá»­ lÃ½ encoding náº¿u Ä‘Æ°á»£c chá»n
                let processedContent = originalContent;
                if (this.autoProcess.checked) {
                    processedContent = this.fixEncoding(originalContent);
                    processedContent = this.optimizeContent(processedContent);
                }

                // BÆ°á»›c 3: Upload lÃªn GitHub
                const filePath = `docs/Quyet/processed/${fileName}`;
                const result = await this.uploadToGitHub(processedContent, filePath, token, file.name);
                
                return {
                    ...result,
                    processedContent: processedContent,
                    originalLength: originalContent.length,
                    processedLength: processedContent.length
                };
            }

            // Xá»­ lÃ½ encoding tá»« Windows-1252 sang UTF-8
            fixEncoding(content) {
                console.log('ğŸ”§ Äang xá»­ lÃ½ encoding...');
                
                // Map cÃ¡c kÃ½ tá»± Windows-1252 bá»‹ lá»—i sang UTF-8 chuáº©n
                const encodingMap = {
                    // Vietnamese characters
                    'ÃƒÂ¡': 'Ã¡', 'ÃƒÂ ': 'Ã ', 'Ã¡ÂºÂ¡': 'áº¡', 'Ã¡ÂºÂ£': 'áº£', 'ÃƒÂ£': 'Ã£', 'ÃƒÂ¢': 'Ã¢', 'Ã¡ÂºÂ§': 'áº§', 'Ã¡ÂºÂ¥': 'áº¥', 'Ã¡ÂºÂ­': 'áº­', 'Ã¡ÂºÂ©': 'áº©', 'Ã¡ÂºÂ«': 'áº«',
                    'ÃƒÂ©': 'Ã©', 'ÃƒÂ¨': 'Ã¨', 'Ã¡ÂºÂ¹': 'áº¹', 'Ã¡ÂºÂ»': 'áº»', 'Ã¡ÂºÂ½': 'áº½', 'ÃƒÂª': 'Ãª', 'Ã¡Â»Â': 'á»', 'Ã¡ÂºÂ¿': 'áº¿', 'Ã¡Â»â€¡': 'á»‡', 'Ã¡Â»Æ’': 'á»ƒ', 'Ã¡Â»â€¦': 'á»…',
                    'ÃƒÂ­': 'Ã­', 'ÃƒÂ¬': 'Ã¬', 'Ã¡Â»â€¹': 'á»‹', 'Ã¡Â»â€°': 'á»‰', 'Ã„Â©': 'Ä©',
                    'ÃƒÂ³': 'Ã³', 'ÃƒÂ²': 'Ã²', 'Ã¡Â»Â': 'á»', 'Ã¡Â»Â': 'á»', 'ÃƒÂµ': 'Ãµ', 'ÃƒÂ´': 'Ã´', 'Ã¡Â»â€œ': 'á»“', 'Ã¡Â»â€˜': 'á»‘', 'Ã¡Â»â„¢': 'á»™', 'Ã¡Â»â€¢': 'á»•', 'Ã¡Â»â€”': 'á»—',
                    'ÃƒÂº': 'Ãº', 'ÃƒÂ¹': 'Ã¹', 'Ã¡Â»Â¥': 'á»¥', 'Ã¡Â»Â§': 'á»§', 'Ã…Â©': 'Å©', 'ÃƒÂ°': 'Æ°', 'Ã¡Â»Â«': 'á»«', 'Ã¡Â»Â©': 'á»©', 'Ã¡Â»Â±': 'á»±', 'Ã¡Â»Â­': 'á»­', 'Ã¡Â»Â¯': 'á»¯',
                    'Ã¡Â»Â¹': 'á»µ', 'Ã¡Â»Â³': 'á»³', 'Ã¡Â»Â·': 'á»·', 'Ã¡Â»Â·': 'á»¹',
                    
                    // Uppercase Vietnamese
                    'ÃƒÂ': 'Ã', 'Ãƒâ‚¬': 'Ã€', 'Ã¡ÂºÂ ': 'áº ', 'Ã¡ÂºÂ¢': 'áº¢', 'ÃƒÆ’': 'Ãƒ', 'Ãƒâ€š': 'Ã‚', 'Ã¡ÂºÂ¦': 'áº¦', 'Ã¡ÂºÂ¤': 'áº¤', 'Ã¡ÂºÂ®': 'áº¬', 'Ã¡ÂºÂ¨': 'áº¨', 'Ã¡ÂºÂª': 'áºª',
                    'Ãƒâ€°': 'Ã‰', 'ÃƒË†': 'Ãˆ', 'Ã¡ÂºÂ°': 'áº¸', 'Ã¡ÂºÂº': 'áºº', 'Ã¡ÂºÂ¼': 'áº¼', 'ÃƒÅ ': 'ÃŠ', 'Ã¡Â»â‚¬': 'á»€', 'Ã¡ÂºÂ¾': 'áº¾', 'Ã¡Â»â€¦': 'á»†', 'Ã¡Â»â€š': 'á»‚', 'Ã¡Â»â€': 'á»„',
                    'ÃƒÂ': 'Ã', 'ÃƒÅ’': 'ÃŒ', 'Ã¡Â»Å ': 'á»Š', 'Ã¡Â»Ë†': 'á»ˆ', 'Ã„Â¨': 'Ä¨',
                    'Ãƒâ€œ': 'Ã“', 'Ãƒâ€™': 'Ã’', 'Ã¡Â»Å’': 'á»Œ', 'Ã¡Â»Å½': 'á»', 'Ãƒâ€¢': 'Ã•', 'Ãƒâ€': 'Ã”', 'Ã¡Â»â€œ': 'á»’', 'Ã¡Â»Â': 'á»', 'Ã¡Â»Å“': 'á»˜', 'Ã¡Â»â€': 'á»”', 'Ã¡Â»â€“': 'á»–',
                    'ÃƒÅ¡': 'Ãš', 'Ãƒâ„¢': 'Ã™', 'Ã¡Â»Â¤': 'á»¤', 'Ã¡Â»Â¦': 'á»¦', 'Ã…Â¨': 'Å¨', 'ÃƒÅ¾': 'Æ¯', 'Ã¡Â»Âª': 'á»ª', 'Ã¡Â»Â¨': 'á»¨', 'Ã¡Â»Â°': 'á»°', 'Ã¡Â»Â¬': 'á»¬', 'Ã¡Â»Â®': 'á»®',
                    
                    // Common special characters
                    'Ã¢â‚¬Â': '"', 'Ã¢â‚¬Å“': '"', 'Ã¢â‚¬â„¢': "'", 'Ã¢â‚¬Â¦': '...',
                    'ÃƒÂ§': 'Ã§', 'Ãƒâ€¡': 'Ã‡',
                    'ÃƒÂ±': 'Ã±', 'Ãƒâ€˜': 'Ã‘',
                    'Ã‚': '', // Remove extra Ã‚ characters
                    
                    // Fix common mojibake
                    'Ã†Â¡': 'Æ¡', 'Ã†Â¯': 'Æ°',
                    'Ã¢Â»Âƒ': 'á»³', 'Ã¢Â»': 'á»µ', 'Ã¢Â»â€¡': 'á»·', 'Ã¢Â»â€°': 'á»¹'
                };

                let fixedContent = content;
                
                // Thay tháº¿ cÃ¡c kÃ½ tá»± lá»—i
                for (const [wrong, correct] of Object.entries(encodingMap)) {
                    const regex = new RegExp(wrong, 'g');
                    fixedContent = fixedContent.replace(regex, correct);
                }

                // Fix additional common patterns
                fixedContent = fixedContent.replace(/ÃƒÂƒÃ‚Â¡/g, 'Ã¡');
                fixedContent = fixedContent.replace(/ÃƒÂƒÃ‚Â /g, 'Ã ');
                fixedContent = fixedContent.replace(/ÃƒÂƒÃ‚Â©/g, 'Ã©');
                
                console.log('âœ… Encoding Ä‘Ã£ Ä‘Æ°á»£c xá»­ lÃ½');
                return fixedContent;
            }

            // Tá»‘i Æ°u hÃ³a ná»™i dung HTML
            optimizeContent(content) {
                console.log('ğŸ”§ Äang tá»‘i Æ°u hÃ³a ná»™i dung...');
                
                // Äáº£m báº£o meta charset UTF-8
                if (!content.includes('<meta charset=')) {
                    if (content.includes('<head>')) {
                        content = content.replace('<head>', '<head>\n    <meta charset="UTF-8">');
                    } else if (content.includes('<html>')) {
                        content = content.replace('<html>', '<html>\n<head>\n    <meta charset="UTF-8">\n</head>');
                    } else {
                        content = '<!DOCTYPE html>\n<html>\n<head>\n    <meta charset="UTF-8">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n</head>\n<body>\n' + content + '\n</body>\n</html>';
                    }
                }

                // Äáº£m báº£o viewport meta
                if (!content.includes('viewport')) {
                    content = content.replace('<head>', '<head>\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">');
                }

                console.log('âœ… Ná»™i dung Ä‘Ã£ Ä‘Æ°á»£c tá»‘i Æ°u hÃ³a');
                return content;
            }

            async uploadToGitHub(content, filePath, token, originalFileName) {
                const apiUrl = `https://api.github.com/repos/Datkep92/aquyet/contents/${filePath}`;
                
                const payload = {
                    message: `Auto-processed: ${originalFileName} -> ${filePath.split('/').pop()}`,
                    content: btoa(unescape(encodeURIComponent(content))),
                    branch: 'main'
                };

                const response = await fetch(apiUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `HTTP ${response.status}`);
                }

                const result = await response.json();
                return {
                    html_url: result.content.html_url,
                    download_url: result.content.download_url,
                    path: result.content.path,
                    raw_url: `https://raw.githubusercontent.com/Datkep92/aquyet/main/${filePath}`
                };
            }

            readFileAsText(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = e => resolve(e.target.result);
                    reader.onerror = reject;
                    // Äá»c vá»›i encoding máº·c Ä‘á»‹nh (giá»‘ng browser xá»­ lÃ½)
                    reader.readAsText(file);
                });
            }

            togglePreview() {
                const file = this.fileInput.files[0];
                if (file && this.autoProcess.checked) {
                    this.generatePreview(file);
                } else {
                    this.previewSection.style.display = 'none';
                }
            }

            async generatePreview(file) {
                try {
                    const content = await this.readFileAsText(file);
                    const processedContent = this.fixEncoding(content);
                    
                    // Hiá»ƒn thá»‹ preview (300 kÃ½ tá»± Ä‘áº§u)
                    const preview = processedContent.substring(0, 300) + 
                                  (processedContent.length > 300 ? '...' : '');
                    
                    this.previewContent.textContent = preview;
                    this.previewSection.style.display = 'block';
                    
                } catch (error) {
                    console.error('Lá»—i generate preview:', error);
                }
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            showLoading() {
                this.loading.style.display = 'block';
                this.successResult.style.display = 'none';
                this.errorResult.style.display = 'none';
                this.previewSection.style.display = 'none';
                this.uploadBtn.disabled = true;
            }

            hideLoading() {
                this.loading.style.display = 'none';
                this.uploadBtn.disabled = false;
            }

            showSuccess(result) {
                this.hideLoading();
                this.successMessage.textContent = 
                    `ÄÃ£ xá»­ lÃ½ vÃ  upload "${this.fileInput.files[0].name}" thÃ nh cÃ´ng! 
                     (${result.originalLength} â†’ ${result.processedLength} kÃ½ tá»±)`;
                this.fileLink.href = result.html_url;
                this.fileLink.textContent = result.html_url;
                this.rawLink.href = result.raw_url;
                this.rawLink.textContent = result.raw_url;
                this.successResult.style.display = 'block';
                this.errorResult.style.display = 'none';
                
                // Reset form nhÆ°ng giá»¯ token
                const token = this.githubToken.value;
                this.form.reset();
                this.githubToken.value = token;
                this.fileInfo.textContent = '';
                this.previewSection.style.display = 'none';
            }

            showError(message) {
                this.hideLoading();
                this.errorMessage.textContent = message;
                this.errorResult.style.display = 'block';
                this.successResult.style.display = 'none';
            }
        }

        // Khá»Ÿi táº¡o á»©ng dá»¥ng khi DOM loaded
        document.addEventListener('DOMContentLoaded', () => {
            new GitHubUploader();
        });
    </script>
</body>
</html>
